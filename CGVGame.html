<!DOCTYPE html>
<html lang="en">
    <head>
        <title>CGVGame</title>
        <meta charset="utf-8">
        <meta name ="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0,
        maximum-scale=1.0">
        <link type="text/css" rel="stylesheet" href="css/main.css">
        <style>
            #blocker {
                position:absolute;
                width:100%;
                height: 100%;
                background-color: rgba(30, 30, 30, 0.8);
            }

            #instructions {
                width:100%;
                height: 100%;

                display: -webkit-box;
                display: -moz-box;
                display: -box;

                -webkit-box-orient: horizontal;
                -moz-box-orient: horizontal;
                box-orient: horizontal;

                -webkit-box-pack: center;
                -moz-box-pack: center;
                box-pack: center;

                -webkit-box-align: center;
                -moz-box-align: center;
                box-align: center;

                color: #ffffff;
                text-align: center;
                font-family: Arial;
                font-size: 14px;
                line-height: 24px;

                cursor: pointer;


            }
        </style>
    </head>
    <body>
        <div id="blocker">

            <div id="instructions">
                <span style="font-size:30px">Click to play level</span>
                <br /><br />
                Move:WASD<br />
                Look:Mouse<br />
                Pause:ESC
            </div>
        </div>

        <script type="module">
            import * as THREE from './js/three.js-master/build/three.module.js';

            import { PointerLockControls } from './js/three.js-master/examples/jsm/controls/PointerLockControls.js';

            var camera, scene, renderer, controls;

            var objects = [];

            var raycaster;

            var moveForward = false;
            var moveBackward = false;
            var moveLeft = false;
            var moveRight = false;
            var canJump = false;

            var prevTime = performance.now();
            var velocity = new THREE.Vector3();
            var direction = new THREE.Vector3();
            var vertex = new THREE.Vector3();
            var color = new THREE.Color();

            init();
            animate();

            function init() {

                camera = new THREE.PerspectiveCamera(75,window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.y = 11.5;
                camera.position.x = 20;

                scene = new THREE.Scene();
                scene.background = new THREE.Color (0xffffff);
                scene.fog = new THREE.Fog(0xffffff, 0, 750);

                var light = new THREE.HemisphereLight(0xeeeeee, 0x777777, 0.75);
                light.position.set (0.5,1,0.75);
                scene.add(light);

                controls = new PointerLockControls (camera, document.body);

                var blocker = document.getElementById('blocker');
                var instructions = document.getElementById('instructions')

                instructions.addEventListener('click', function (){controls.lock();}, false);

                controls.addEventListener('lock', function() {
                    blocker.style.display = 'none';
                    instructions.style.display = 'none';
                });

                controls.addEventListener('unlock', function() {
                    blocker.style.display = 'block';
                    instructions.style.display = '';
                })

                scene.add (controls.getObject());

                var onKeyDown = function(event){
                    switch ( event.keyCode ) {

                        case 38: // up
                            moveForward = true;
                            break;
                        case 87: // w
                            moveForward = true;
                            break;

                        case 37: // left
                            moveLeft = true;
                            break;
                        case 65: // a
                            moveLeft = true;
                            break;

                        case 40: // down
                            moveBackward = true;
                            break;
                        case 83: // s
                            moveBackward = true;
                            break;

                        case 39: // right
                            moveRight = true;
                            break;
                        case 68: // d
                            moveRight = true;
                            break;

                        case 32: // space
                            if ( canJump === true ) velocity.y += 150;
                            canJump = false;
                            break;

                        //case 69: //esc
                        //   controls.unlock();
                        //    break;
                    }
                };

                var onKeyUp = function (event) {
                    switch ( event.keyCode ) {

                        case 38: // up
                            moveForward = false;
                            break;
                        case 87: // w
                            moveForward = false;
                            break;

                        case 37: // left
                            moveLeft = false;
                            break;
                        case 65: // a
                            moveLeft = false;
                            break;

                        case 40: // down
                            moveBackward = false;
                            break;
                        case 83: // s
                            moveBackward = false;
                            break;

                        case 39: // right
                            moveRight = false;
                            break;
                        case 68: // d
                            moveRight = false;
                            break;

                    }
                };

                document.addEventListener('keydown', onKeyDown, false);
                document.addEventListener('keyup', onKeyUp, false);

                raycaster = new THREE.Raycaster( new THREE.Vector3(), new THREE.Vector3( 0, - 1, 0 ), 0, 10 );

                addObjects();
                renderer = new THREE.WebGLRenderer({antialias:true});
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                window.addEventListener('resize', onWindowResize, false);
            }

            function addObjects() {
                var texture = new THREE.TextureLoader().load( "textures/concrete2.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_concrete2 = new THREE.MeshBasicMaterial({map: texture})

                var texture = new THREE.TextureLoader().load( "textures/grass.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_grass = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/concrete3.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_concrete3 = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/building1.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_building1 = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/granite.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_granite = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/bricks.jpeg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 3, 1 );
                var material_bricks = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/building2.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_building2 = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/granite1.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_granite1 = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/granite2.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 1, 1 );
                var material_granite2 = new THREE.MeshBasicMaterial({map: texture});

                var texture = new THREE.TextureLoader().load( "textures/bricks1.jpg" );
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 2, 1 );
                var material_bricks1 = new THREE.MeshBasicMaterial({map: texture});

                //------------------- Create the scene's visible objects ----------------------

                var worldModel = new THREE.Object3D();

                // --------- Ground ---------//

                var geometry = new THREE.BoxGeometry( 200, 1, 80 );
                var ground = new THREE.Mesh( geometry, material_grass );

                var geometry1 = new THREE.CircleGeometry( 35, 32 );
                var geometry2 = new THREE.CircleGeometry( 40, 32 );

                var circlefloor = new THREE.Mesh( geometry1, material_concrete2 );
                var circlefloor2 = new THREE.Mesh( geometry2, material_concrete3 );

                var geometry4 = new THREE.PlaneGeometry( 30, 60, 32 );
                var plane = new THREE.Mesh( geometry4, material_concrete2 );
                var greyfloor = new THREE.Mesh( geometry4, material_granite );
                var greyfloor1 = new THREE.Mesh( geometry4, material_granite1);
                var greyfloor2 = new THREE.Mesh( geometry4, material_granite2);

                worldModel.add(plane);
                plane.rotateX(-1.5707963268);
                plane.rotateZ(1.1344640138);
                plane.position.y = 0.8;
                plane.position.x = -55;
                plane.position.z = 25;

                worldModel.add(plane.clone());
                plane.rotateZ(-2.3561944902);
                plane.position.x = 50;
                plane.position.z = 30;

                worldModel.add(greyfloor);
                greyfloor.rotateX(-1.5707963268);
                greyfloor.rotateZ(2.6616271093);
                greyfloor.scale.set(1.4,1,1.25);
                greyfloor.position.y = 1;
                greyfloor.position.x = -120;
                greyfloor.position.z = -27.5;

                worldModel.add(greyfloor1);
                greyfloor1.rotateX(-1.5707963268);
                greyfloor1.rotateZ(1.5707963268);
                greyfloor1.scale.set(1.4,1,1.25);
                greyfloor1.position.y = 1;
                greyfloor1.position.z = -75;

                worldModel.add(greyfloor2);
                greyfloor2.rotateX(-1.5707963268);
                greyfloor2.rotateZ(-2.7925268032);
                greyfloor2.scale.set(1.4,1,1.25);
                greyfloor2.position.y = 1;
                greyfloor2.position.x = 90;
                greyfloor2.position.z = 0.25;

                worldModel.add(circlefloor2);
                circlefloor2.rotateX(-1.5707963268);
                circlefloor2.position.y = 0.9;
                circlefloor2.position.x = -2.5;
                circlefloor2.position.z = 60;

                worldModel.add(circlefloor);
                circlefloor.rotateX(-1.5707963268);
                circlefloor.position.y = 1;
                circlefloor.position.x = -2.5;
                circlefloor.position.z = 60;

                ground.rotateY(-0.436332313);
                ground.position.x = -59;
                ground.position.y = 0.2;
                worldModel.add( ground );

                worldModel.add(ground.clone())
                ground.rotateY(-2.3561944902);
                ground.position.x = 59;
                ground.position.z = 3.5;
                ground.position.y = 0.15

                worldModel.add(ground.clone());
                ground.rotateY(1.2217304764);
                ground.scale.set(0.75,1,1);
                ground.position.x = 0;
                ground.position.z = -30;
                ground.position.y = 0.01

                // --------- Houses ---------//

                var geometry3 = new THREE.BoxGeometry(15,15,10);
                var smallhouse = new THREE.Mesh(geometry3, material_building1 );
                var bighouse = new THREE.Mesh(geometry3, material_building2);

                worldModel.add(smallhouse);
                objects.push(smallhouse);
                smallhouse.position.x = -15;
                smallhouse.position.y = 8;
                smallhouse.position.z = 77.5;

                worldModel.add(smallhouse.clone());
                objects.push(smallhouse);
                smallhouse.position.x = 15;

                worldModel.add(smallhouse.clone());
                objects.push(smallhouse);
                smallhouse.position.z = 45;

                worldModel.add(smallhouse.clone());
                objects.push(smallhouse);
                smallhouse.position.x = -15;
                smallhouse.position.z = 45;

                worldModel.add(smallhouse.clone());
                objects.push(smallhouse);
                smallhouse.position.z = 20;
                smallhouse.position.x = -70;
                smallhouse.scale.set(1.25,1,1);
                smallhouse.rotateY(1.1344640138);

                worldModel.add(smallhouse.clone());
                objects.push(smallhouse);
                smallhouse.position.x = -45;
                smallhouse.position.z = 32.5;

                worldModel.add(bighouse);
                objects.push(bighouse);
                bighouse.rotateY(0.3490658504);
                bighouse.scale.set(2,2,2);
                bighouse.position.x = 50;
                bighouse.position.y = 16;
                bighouse.position.z = 32.5;

                // --------- Trees ---------//


                var tree = new THREE.Object3D();
                var trunk = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.2,0.2,3,16,1),
                    new THREE.MeshLambertMaterial({
                        color: 0x885522
                    })
                );
                trunk.position.y = 0.5;  // move base up to origin
                var leaves = new THREE.Mesh(
                    new THREE.CylinderGeometry(0,1,2,16,3),
                    new THREE.MeshPhongMaterial({
                        color: 0x00BB00,
                        specular: 0x002000,
                        shininess: 5
                    })
                );
                leaves.position.y = 3;  // move bottom of cone to top of trunk
                tree.add(trunk);
                tree.add(leaves);
                tree.position.y = 3;
                worldModel.add(tree);
                objects.push(tree);
                tree.scale.set(4,4,4);

                worldModel.add(tree.clone());
                objects.push(tree);
                tree.position.x = -85;
                tree.position.z = -40;

                worldModel.add(tree.clone());
                objects.push(tree);
                tree.position.x = -110;
                tree.position.z = 10;

                worldModel.add(tree.clone());
                objects.push(tree);
                tree.position.x = -50;

                worldModel.add(tree.clone());
                objects.push(tree);
                tree.position.z = -15;

                worldModel.add(tree.clone());
                objects.push(tree);
                tree.position.x = -30;

                // --------- Walls ---------//

                var geometry5 = new THREE.BoxGeometry(80,10,1);
                var redwalls = new THREE.Mesh(geometry5, material_bricks );
                var build = new THREE.Object3D();
                var greywall = new THREE.Mesh(geometry5, material_bricks1 );

                worldModel.add(build);
                objects.push(build);
                build.add(greywall);
                greywall.scale.set(0.74,1.5,1);
                greywall.position.y = 8;
                greywall.position.z = -96.5;

                build.add(greywall.clone());
                greywall.scale.set(0.3,1.5,1);
                greywall.position.x = -18;
                greywall.position.z = -53.5;

                build.add(greywall.clone());
                greywall.position.x = 18;

                build.add(greywall.clone());
                greywall.scale.set(0.55,1.5,1);
                greywall.rotateY(1.5707963268);
                greywall.position.x = 30;
                greywall.position.z = -75;

                build.add(greywall.clone());
                greywall.position.x = -30;
                objects.push(build);

                worldModel.add(build.clone());
                objects.push(build);
                build.rotateY(1.5707963268);

                worldModel.add(redwalls);
                objects.push(redwalls);
                redwalls.position.y = 4.5;
                redwalls.position.z = -105;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.rotateY(1.1344640138);
                redwalls.position.x = -149.5;
                redwalls.position.z = -42;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.rotateY(0.436332313);
                redwalls.scale.set(0.9,1,1);
                redwalls.position.x = -40;
                redwalls.position.z = -70;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.position.x = 40;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.rotateY(-1.2217304764);
                redwalls.scale.set(1.32,1,1);
                redwalls.position.x = 89;
                redwalls.position.z = -50.7;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.scale.set(1.73,1,1);
                redwalls.position.x = 101.5;
                redwalls.position.z = 31.5;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.rotateY(-0.7853981634);
                redwalls.position.x = -105;
                redwalls.position.z = 23.5;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.scale.set(1.27,1,1);
                redwalls.position.x = -87;
                redwalls.position.z = -57;

                worldModel.add(redwalls.clone());
                objects.push(redwalls);
                redwalls.rotateY(-0.7853981634)
                redwalls.scale.set(1.02,1,1);
                redwalls.position.x = 153;
                redwalls.position.z = -31;

                scene.add(worldModel);

            }

            function onWindowResize() {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function animate() {
                requestAnimationFrame(animate);
                if (controls.isLocked === true) {

                    raycaster.ray.origin.copy((controls.getObject().position));
                    raycaster.ray.origin.y -= 10;

                    var intersections =  raycaster.intersectObjects(objects);

                    var onObject = intersections.length > 0;

                    var time = performance.now();
                    var delta = (time - prevTime) / 1000;

                    velocity.x -= velocity.x * 10 * delta;
                    velocity.z -= velocity.z * 10 * delta;

                    velocity.y -= 9.8 * 100 * delta; // 100 = mass

                    direction.z = Number(moveForward) - Number(moveBackward);
                    direction.x = Number(moveRight) - Number(moveLeft);
                    direction.normalize();

                    if ( moveForward || moveBackward ) velocity.z -= direction.z * 400.0 * delta;
                    if ( moveLeft || moveRight ) velocity.x -= direction.x * 400.0 * delta;

                    if ( onObject === true ) {

                        velocity.y = Math.max( 0, velocity.y );
                        canJump = true;

                    }

                    controls.moveRight (-velocity.x * delta);
                    controls.moveForward (-velocity.z * delta);

                    controls.getObject().position.y += ( velocity.y * delta );

                    if ( controls.getObject().position.y < 11.5 ) {

                        velocity.y = 0;
                        controls.getObject().position.y = 11.5;

                        canJump = true;

                    }


                    prevTime = time;
                }
            renderer.render(scene, camera);
            }
        </script>
    </body>
</html>